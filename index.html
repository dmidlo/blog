<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog</title>

    <script type="module">
        import {React, ReactDOM} from 'https://unpkg.com/es-react@16.13.1'
        import htm from 'https://unpkg.com/htm?module'
        import { endpoint } from 'https://cdn.skypack.dev/@octokit/endpoint'
        import marked from 'https://unpkg.com/marked@2.0.0/lib/marked.esm.js'

        const TOKEN = "x"

        const html = htm.bind(React.createElement)


        const Posts = (props) => {

            // create the an array to hold github issues and
            // get a function to update that array (setIssues)
            const [issues, setIssues] = React.useState([])

            // use octokit to access github api and fetch issues from
            // the blog repo.  store those issues in issues array using
            // setIssues
            React.useEffect(() => {
                async function fetchIssues() {
                    const {url, ...options} = endpoint("GET /repos/:owner/:repo/issues", {
                        owner: "dmidlo",
                        repo: "blog",
                        auth: TOKEN,
                    })
                    const response = await fetch(url, options)
                    const issues = await response.json()
                    setIssues(issues)
                }
                fetchIssues()
            }, [])


            // Render issues as posts
            const {search} = window.location
            return html` 
                ${issues
                    .filter(({user}) => user.login === "dmidlo")
                    .filter(({number}) => !search || Number(search.slice(1)) === number )
                    .map(({number, title, body}) => {
                    return html`
                        <div id=${number} key=${number}>
                            <h2>
                                <a href="?${number}"> ${title} </a>
                            </h2>
                            <div dangerouslySetInnerHTML="${{__html: marked(body)}}" />
                        </div>
                    `
                })}
            `
        }
        ReactDOM.render(html` <${Posts} />`, document.body)
    </script>
</head>
<body>
    
</body>
</html>