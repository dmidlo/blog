<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog</title>

    <script type="module">
        import {React, ReactDOM} from 'https://unpkg.com/es-react@16.13.1'
        import htm from 'https://unpkg.com/htm?module'
        import { endpoint } from 'https://cdn.skypack.dev/@octokit/endpoint'
        import marked from 'https://unpkg.com/marked@2.0.0/lib/marked.esm.js'
        import hljs from 'https://unpkg.com/@highlightjs/cdn-assets@11.5.1/es/highlight.min.js'
        import powershell from 'https://unpkg.com/@highlightjs/cdn-assets@11.5.1/es/languages/powershell.min.js'
        import dos from 'https://unpkg.com/@highlightjs/cdn-assets@11.5.1/es/languages/dos.min.js'
        hljs.registerLanguage('powershell', powershell)
        hljs.registerLanguage('dos', dos)
        
        marked.setOptions({
              renderer: new marked.Renderer(),
              highlight: function(code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext'
                return hljs.highlight(code, { language }).value
              },
              langPrefix: 'hljs language-', // highlight.js css expects a top-level 'hljs' class.
              pedantic: false,
              gfm: true,
              breaks: false,
              sanitize: false,
              smartLists: true,
              smartypants: false,
              xhtml: false
            })

        // the original source for this code recommended creating a non-scoped
        // "read-only" personal access token for github.  Pure nonsense!!!
        // public repos on github are read-only by default.  whoever came up with that
        // was depending too much on the octokit/endpoint documentation.  to still use
        // octokit without granting read-only access to all your private repos by exposing
        // a token in the html of your site... simply put any old string into endpoint's
        // auth parameter.
        const TOKEN = "x"

        const html = htm.bind(React.createElement)


        const Posts = (props) => {

            // create the an array to hold github issues and
            // get a function to update that array (setIssues)
            const [issues, setIssues] = React.useState([])

            // use octokit to access github api and fetch issues from
            // the blog repo.  store those issues in issues array using
            // setIssues
            React.useEffect(() => {
                async function fetchIssues() {
                    const {url, ...options} = endpoint("GET /repos/:owner/:repo/issues", {
                        owner: "dmidlo",
                        repo: "blog",
                        auth: TOKEN,
                    })
                    const response = await fetch(url, options)
                    const issues = await response.json()
                    setIssues(issues)
                }
                fetchIssues()
            }, [])


            // Render issues as posts
            const {search} = window.location
            return html` 
                ${issues
                    .filter(({user}) => user.login === "dmidlo")
                    .filter(({number}) => !search || Number(search.slice(1)) === number )
                    .map(({number, title, body}) => {
                    return html`
                        <div id=${number} key=${number}>
                            <h2>
                                <a href="?${number}"> ${title} </a>
                            </h2>
                            <div dangerouslySetInnerHTML="${{__html: marked(body)}}" />
                        </div>
                    `
                })}
            `
        }
        ReactDOM.render(html` <${Posts} />`, document.body)
    </script>
</head>
<body>
    
</body>
</html>
